# 3.1 访问控制引擎

## 3.1.1 概述

本节详细描述基于Apache ShardingSphere和OPA的访问控制引擎实现方案，实现表级和列级的数据访问控制。

## 3.1.2 技术选型

### 方案对比

| 方案 | 推荐指数 | 成熟度 | 列级安全 | 表级安全 | 部署简单性 | 性能 |
|-----|------|--------|---------|---------|-----------|------|
| **Apache ShardingSphere** | ⭐⭐⭐⭐⭐ | 非常高 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| **OPA** | ⭐⭐⭐⭐ | 高 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| **ProxySQL** | ⭐⭐⭐⭐ | 高 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **Calcite** | ⭐⭐⭐ | 中等 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |

### 推荐架构：ShardingSphere Proxy + OPA

**ShardingSphere负责**：
- 数据脱敏（Column Masking）
- SQL解析和改写
- 数据库代理层
- 透明数据访问

**OPA负责**：
- 细粒度策略决策
- 访问控制规则
- 策略集中管理
- 审计日志

## 3.1.3 实现架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用层                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              统一访问控制API接口                          │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                    ShardingSphere Proxy层                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │  SQL解析    │  │  数据脱敏   │  │  连接池管理             │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │  读写分离   │  │  路由规则   │  │  SQL审计日志            │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                      OPA策略引擎层                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Rego策略定义与决策                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              策略缓存（Redis）                           │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                      数据源层                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌────────────────┐  │
│  │  客户原始数据库  │  │  Milvus向量库   │  │  GaussDB       │  │
│  │  （不加任何列）  │  │  （DCPE加密）   │  │  （元数据）    │  │
│  └─────────────────┘  └─────────────────┘  └────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 3.1.4 ShardingSphere配置

### 数据脱敏规则配置

```yaml
# sharding-config.yaml
rules:
  - tables:
      customer_info:
        columns:
          phone:
            encryptorName: phone_encryptor
            type: AES
          salary:
            encryptorName: salary_encryptor
            type: AES
          id_card:
            encryptorName: id_masking
            type: MASK
        queryWithCipherColumn: false

  encryptors:
    phone_encryptor:
      type: AES
      props:
        aes-key-value: your-aes-key
    salary_encryptor:
      type: AES
      props:
        aes-key-value: your-aes-key
    id_masking:
      type: MASK
      props:
        mask-character: "*"
        mask-start: 6
        mask-length: 8
```

### 列级访问控制配置

```yaml
# column-access-rules.yaml
rules:
  - access_control:
      - table: customer_info
        columns:
          - name: phone
            roles:
              - admin: full_access
              - manager: read_only
              - user: masked
          - name: salary
            roles:
              - admin: full_access
              - manager: no_access
              - user: no_access
```

## 3.1.5 OPA策略配置

### Rego策略定义

```rego
package data_access

# 允许访问的列
allow_column(table, column, role) {
    role == "admin"
    allow_table(table, role)
}

allow_column(table, column, role) {
    role == "manager"
    allow_table(table, role)
    not restricted_column[table][column]
}

allow_column(table, column, role) {
    role == "user"
    allow_table(table, role)
    public_column[table][column]
}

# 允许访问的表
allow_table(table, role) {
    role == "admin"
}

allow_table(table, role) {
    role == "manager"
    manager_allowed_tables[table]
}

allow_table(table, role) {
    role == "user"
    user_allowed_tables[table]
}

# 公共列（所有角色可访问）
public_column["customer_info"] = {"id", "name", "create_time"}

# 受限列（仅管理员可访问）
restricted_column["customer_info"] = {"salary", "id_card"}

# 管理员允许的表
manager_allowed_tables = {"customer_info", "order_info"}

# 普通用户允许的表
user_allowed_tables = {"customer_info"}
```

### OPA API调用

```bash
# 策略决策请求
curl -X POST http://opa:8181/v1/data/data_access/allow \
  -H "Content-Type: application/json" \
  -d '{
    "input": {
      "table": "customer_info",
      "column": "salary",
      "role": "user"
    }
  }'

# 响应
{"result": false}
```

## 3.1.6 技术实现

### 权限判断流程

```
用户请求 → ShardingSphere解析 → OPA策略决策 → 数据脱敏 → 执行SQL → 返回结果
```

### 动态SQL构建

```python
class SecureQueryBuilder:
    def __init__(self, opa_client, sharding_config):
        self.opa_client = opa_client
        self.sharding_config = sharding_config
    
    def build_secure_query(self, user, table, requested_columns):
        # 1. 获取用户角色和权限
        user_role = user.role
        tenant_id = user.tenant_id
        
        # 2. 调用OPA进行策略决策
        allowed_columns = []
        for column in requested_columns:
            decision = self.opa_client.check_access(
                table=table,
                column=column,
                role=user_role,
                tenant_id=tenant_id
            )
            if decision.allowed:
                if decision.masked:
                    allowed_columns.append(f"MASK({column})")
                else:
                    allowed_columns.append(column)
        
        # 3. 构建最终SQL
        if not allowed_columns:
            raise AccessDeniedException("无权限访问该表")
        
        query = f"""
            SELECT {', '.join(allowed_columns)}
            FROM {table}
            WHERE tenant_id = '{tenant_id}'
        """
        
        return self.sharding_config.execute(query)
```

### 数据脱敏函数

```sql
-- ShardingSphere内置脱敏函数
SELECT 
    id,
    name,
    MASK(phone) as phone,           -- 手机号脱敏
    MASK(id_card, 6, 8) as id_card,  -- 身份证号脱敏
    salary                           -- 管理员可看到原始值
FROM customer_info
WHERE tenant_id = 'tenant_a';
```

## 3.1.7 部署配置

### ShardingSphere Proxy K8s部署

```yaml
# sharding-proxy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sharding-proxy
  namespace: data-layer
spec:
  replicas: 3
  selector:
    matchLabels:
      app: sharding-proxy
  template:
    metadata:
      labels:
        app: sharding-proxy
    spec:
      containers:
      - name: sharding-proxy
        image: apache/sharding-proxy:5.3.2
        ports:
        - name: mysql
          containerPort: 3307
        env:
        - name: JAVA_OPTS
          value: "-Xmx2g -Xms1g"
        resources:
          requests:
            cpu: "500m"
            memory: "2Gi"
          limits:
            cpu: "2000m"
            memory: "4Gi"
        volumeMounts:
        - name: config
          mountPath: /opt/sharding-proxy/conf
      volumes:
      - name: config
        configMap:
          name: sharding-proxy-config
```

### OPA K8s部署

```yaml
# opa.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opa
  namespace: data-layer
spec:
  replicas: 2
  selector:
    matchLabels:
      app: opa
  template:
    metadata:
      labels:
        app: opa
    spec:
      containers:
      - name: opa
        image: openpolicyagent/opa:0.55.0
        args:
        - "run"
        - "--server"
        - "--addr=:8181"
        - "--log-level=info"
        ports:
        - name: http
          containerPort: 8181
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "1Gi"
```

## 3.1.8 交付物清单

- [ ] ShardingSphere部署配置
- [ ] OPA策略配置
- [ ] 数据脱敏规则文档
- [ ] API接口文档
- [ ] 策略管理平台
- [ ] 性能测试报告

## 3.1.9 验收标准

- [ ] 支持表级、列级、行级控制
- [ ] 性能满足要求（<100ms）
- [ ] 测试覆盖率>80%
- [ ] 数据脱敏正常工作
- [ ] OPA策略生效
- [ ] 审计日志完整

## 3.1.10 工时估算

| 任务 | 工时 |
|-----|------|
| ShardingSphere部署 | 4人天 |
| OPA策略配置 | 4人天 |
| 数据脱敏规则 | 3人天 |
| API接口开发 | 4人天 |
| 性能优化 | 3人天 |
| 测试验证 | 4人天 |
| **总计** | **22人天** |

## 3.1.11 相关文档

- [ODBC数据访问层](./3.2-ODBC数据访问层.md)
- [部署配置](./部署配置/sharding-proxy.yaml)
- [主项目文档](../项目工作分解结构.md)

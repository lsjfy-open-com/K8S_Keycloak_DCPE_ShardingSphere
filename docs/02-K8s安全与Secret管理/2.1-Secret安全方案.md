# 2.1 Secret安全方案

## 2.1.1 概述

本节详细描述K8s Secret安全方案，包括静态加密、密钥轮换、RBAC控制和Vault集成。

## 2.1.2 Secret加密配置

### 启用静态加密

```yaml
# encryption-config.yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
    - secrets
    - configmaps
    providers:
    - aescbc:
        keys:
        - name: key1
          secret: <base64-encoded-key-32bytes>
    - identity: {}
```

### K8s API Server配置

```yaml
# kube-apiserver.yaml
apiVersion: v1
kind: Pod
metadata:
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-apiserver
    - --encryption-provider-config=/etc/kubernetes/encryption-config.yaml
    - --encryption-provider-config-automatic-reload=true
    volumeMounts:
    - name: encryption-config
      mountPath: /etc/kubernetes
      readOnly: true
  volumes:
  - name: encryption-config
    hostPath:
      path: /etc/kubernetes
      type: File
```

## 2.1.3 HashiCorp Vault集成

### Vault Agent配置

```yaml
# vault-agent-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-agent-config
data:
  config.hcl: |
    exit_after_auth = false
    pid_file = "/home/vault/pidfile"
    
    auto_auth {
      method "kubernetes" {
        mount_path = "auth/kubernetes"
        config = {
          role = "keycloak-app"
        }
      }
      
      sink "file" {
        config = {
          path = "/home/vault/.vault-token"
        }
      }
    }
    
    template {
      source = "/etc/vault/templates/secret.tpl"
      destination = "/etc/secrets/app/secret.yml"
    }
```

### Vault K8s部署

```yaml
# vault.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vault
  namespace: kube-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: vault
  template:
    metadata:
      labels:
        app: vault
    spec:
      containers:
      - name: vault
        image: vault:1.13.0
        ports:
        - containerPort: 8200
        env:
        - name: VAULT_ADDR
          value: "http://127.0.0.1:8200"
        - name: VAULT_SEAL_TYPE
          value: "kubernetes"
```

## 2.1.4 RBAC配置

```yaml
# rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-reader
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-secrets
subjects:
- kind: ServiceAccount
  name: keycloak-app
  namespace: default
roleRef:
  kind: Role
  name: secret-reader
  apiGroup: rbac.authorization.k8s.io
```

## 2.1.5 密钥轮换策略

```yaml
# secret-rotation-policy.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: key-rotation-policy
data:
  rotation-policy.yaml: |
    secrets:
      - name: db-credentials
        rotation_period: "30d"
        auto_rotate: true
      - name: api-keys
        rotation_period: "90d"
        auto_rotate: true
      - name: tls-certificates
        rotation_period: "365d"
        auto_rotate: true
```

## 2.1.6 交付物清单

- [ ] Secret安全配置文档
- [ ] 密钥轮换策略文档
- [ ] RBAC配置清单
- [ ] Vault集成方案
- [ ] 备份恢复方案
- [ ] 审计日志配置

## 2.1.7 验收标准

- [ ] Secret以加密形式存储
- [ ] 解密功能正常
- [ ] Vault集成成功
- [ ] RBAC配置生效
- [ ] 密钥轮换正常工作
- [ ] 审计日志完整

## 2.1.8 工时估算

| 任务 | 工时 |
|-----|------|
| Secret加密配置 | 2人天 |
| Vault集成 | 4人天 |
| RBAC配置 | 2人天 |
| 密钥轮换 | 3人天 |
| 审计日志 | 2人天 |
| 测试验证 | 3人天 |
| **总计** | **16人天** |

## 2.1.9 相关文档

- [主项目文档](../项目工作分解结构.md)

# 7.1 总体架构设计

## 7.1.1 系统分层架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          接入层（Access Layer）                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │
│  │  Kong API网关   │  │  CDN加速       │  │  WAF防火墙             │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                          网关层（Gateway Layer）                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Keycloak OAuth2/OIDC                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │   │
│  │  │  认证服务   │  │  授权服务   │  │  会话管理              │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                          服务层（Service Layer）                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │  应用服务A  │  │  应用服务B  │  │  应用服务C  │  │  调度服务   │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                        数据访问层（Data Access Layer）                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │              Apache ShardingSphere + OPA                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │   │
│  │  │  数据脱敏   │  │  访问控制   │  │  SQL审计              │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                          数据层（Data Layer）                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │
│  │  高斯数据库     │  │  Milvus向量库   │  │  Redis缓存             │ │
│  │  （关系数据）   │  │  （DCPE加密）   │  │  （会话缓存）          │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                          基础设施层（Infrastructure Layer）              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │
│  │  K8s集群        │  │  Vault密钥管理  │  │  监控日志              │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

## 7.1.2 组件交互关系

### 认证流程
```
用户请求 → Kong网关 → Keycloak认证 → 获取Token → 访问应用服务
                                                    ↓
                                            ShardingSphere数据访问
                                                    ↓
                                            高斯数据库/Milvus
```

### 数据访问流程
```
应用服务 → ShardingSphere Proxy → OPA策略决策 → 数据脱敏 → 执行SQL → 返回结果
```

## 7.1.3 数据流设计

### 读操作数据流
```
1. 用户发起查询请求
2. Kong验证JWT Token
3. ShardingSphere解析SQL
4. OPA检查访问权限
5. 根据权限决定是否脱敏
6. 执行查询并返回结果
```

### 写操作数据流
```
1. 用户发起写入请求
2. Kong验证JWT Token
3. ShardingSphere验证权限
4. OPA二次确认权限
5. 执行写入操作
6. 记录审计日志
```

## 7.1.4 故障隔离策略

### 组件级隔离
- Keycloak集群独立部署
- ShardingSphere读写分离
- Milvus分片存储
- Redis Sentinel高可用

### 租户级隔离
- 数据库Schema隔离
- 缓存分区隔离
- 队列分区隔离

## 7.1.5 相关文档

- [技术选型依据](./7.2-技术选型依据.md)
- [集成方案](./7.3-集成方案.md)
- [部署拓扑](./7.4-部署拓扑.md)

# 4.1 Milvus向量数据库集成（DCPE加密）

## 4.1.1 概述

本节详细描述基于DCPE加密算法的Milvus向量数据库集成方案，实现关键价值数据和隐私原始数据的向量化安全增强。

## 4.1.2 DCPE加密算法说明

**DCPE（Data Classification and Privacy Encryption）** 是一种数据安全增强方案：

- **数据分类**：根据敏感程度分为公开、内部、机密、绝密四个级别
- **隐私脱敏**：对隐私数据进行脱敏处理后向量化
- **向量加密**：关键数据加密后存储为向量
- **权限控制**：基于向量相似度的细粒度访问控制

### 权限级别映射

```
1: 公开级别 - 可访问公开数据
2: 内部级别 - 可访问内部和公开数据
3: 机密级别 - 可访问机密、内部和公开数据
4: 绝密级别 - 可访问所有数据
```

## 4.1.3 实现架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      数据处理层                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              DCPE加密引擎                                │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│  │  │  数据分类   │  │  隐私脱敏   │  │  向量加密       │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                      Milvus向量库                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              向量索引层                                  │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│  │  │  加密向量   │  │  脱敏向量   │  │  权限向量       │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                      访问控制层                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              权限验证与向量检索                          │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 4.1.4 DCPE加密实现

### 数据分类与加密策略

```python
class DCPESecurityEngine:
    
    def classify_and_encrypt(self, data, sensitivity_level):
        """
        根据敏感级别进行分类和加密
        """
        if sensitivity_level == "critical":
            # 关键价值数据：完全加密存储
            return self.encrypt_critical_data(data)
        elif sensitivity_level == "private":
            # 隐私数据：脱敏后向量化
            return self.mask_and_vectorize(data)
        elif sensitivity_level == "internal":
            # 内部数据：仅向量化
            return self.vectorize(data)
        else:
            # 公开数据：直接存储
            return data
    
    def encrypt_critical_data(self, data):
        """
        关键数据加密：使用AES-256加密后向量化
        """
        # 1. AES加密
        encrypted = self.aes_encrypt(data)
        
        # 2. 生成加密向量
        encrypted_vector = self.generate_vector(encrypted)
        
        # 3. 生成权限向量（用于访问控制）
        permission_vector = self.generate_permission_vector(data)
        
        return {
            "encrypted_data": encrypted,
            "encrypted_vector": encrypted_vector,
            "permission_vector": permission_vector,
            "encryption_metadata": {
                "algorithm": "AES-256-GCM",
                "key_version": "v1",
                "timestamp": self.get_timestamp()
            }
        }
    
    def mask_and_vectorize(self, data):
        """
        隐私数据脱敏后向量化
        """
        # 1. 数据脱敏
        masked_data = self.apply_masking_rules(data)
        
        # 2. 生成脱敏向量
        masked_vector = self.generate_vector(masked_data)
        
        # 3. 生成隐私级别向量
        privacy_vector = self.generate_privacy_vector(data)
        
        return {
            "masked_data": masked_data,
            "masked_vector": masked_vector,
            "privacy_vector": privacy_vector,
            "masking_metadata": {
                "rules_applied": self.get_applied_rules(),
                "original_hash": self.hash_original(data)
            }
        }
```

### 向量访问控制

```python
class VectorAccessController:
    
    def check_access(self, user, vector_request):
        """
        基于DCPE的向量访问控制
        """
        # 1. 获取用户权限级别
        user_level = self.get_user_permission_level(user)
        
        # 2. 获取请求数据的敏感级别
        data_level = self.get_data_sensitivity_level(vector_request)
        
        # 3. 权限级别比较
        if not self.has_access(user_level, data_level):
            return AccessDenied(
                reason=f"权限不足：用户级别 {user_level} < 数据级别 {data_level}"
            )
        
        # 4. 生成查询向量
        query_vector = self.generate_query_vector(
            vector_request.query,
            user_level
        )
        
        # 5. 执行向量检索
        results = self.milvus.search(
            collection_name="secure_vectors",
            query_vector=query_vector,
            filter_expression=f"permission_level <= {user_level}"
        )
        
        # 6. 解密返回结果
        decrypted_results = self.decrypt_results(results, user_level)
        
        return decrypted_results
    
    def has_access(self, user_level, data_level):
        """
        权限级别比较
        """
        level_hierarchy = {
            "public": 1,
            "internal": 2,
            "confidential": 3,
            "top_secret": 4
        }
        
        return level_hierarchy.get(user_level, 0) >= level_hierarchy.get(data_level, 0)
```

## 4.1.5 Milvus集合配置

```yaml
# milvus-collection-config.yaml
collections:
  - name: secure_vectors
    description: 安全向量存储（DCPE加密）
    schema:
      fields:
        - name: id
          type: int64
          is_primary_key: true
        - name: encrypted_vector
          type: float_vector
          dim: 512
          description: 加密后的向量
        - name: permission_vector
          type: float_vector
          dim: 64
          description: 权限控制向量
        - name: sensitivity_level
          type: int
          description: "敏感级别：1-公开，2-内部，3-机密，4-绝密"
        - name: encryption_metadata
          type: varchar
          description: 加密元数据JSON
        - name: tenant_id
          type: varchar
          description: 租户ID
    index_params:
      - field_name: encrypted_vector
        index_type: HNSW
        metric_type: COSINE
        params:
          M: 16
          efConstruction: 200
      - field_name: permission_vector
        index_type: IVF_FLAT
        metric_type: COSINE
        params:
          nlist: 1024
```

## 4.1.6 Milvus K8s部署

```yaml
# milvus.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: milvus
  namespace: data-layer
spec:
  replicas: 3
  selector:
    matchLabels:
      app: milvus
  template:
    metadata:
      labels:
        app: milvus
    spec:
      containers:
      - name: milvus
        image: milvusdb/milvus:v2.3.0
        ports:
        - containerPort: 19530
        resources:
          requests:
            cpu: "1000m"
            memory: "4Gi"
          limits:
            cpu: "4000m"
            memory: "16Gi"
```

## 4.1.7 交付物清单

- [ ] DCPE加密引擎设计文档
- [ ] Milvus部署配置
- [ ] 向量访问控制策略
- [ ] 加密向量检索方案
- [ ] 性能优化报告

## 4.1.8 验收标准

- [ ] Milvus集群可用
- [ ] DCPE加密正常工作
- [ ] 向量检索正常
- [ ] 权限控制生效
- [ ] 备份恢复成功

## 4.1.9 工时估算

| 任务 | 工时 |
|-----|------|
| DCPE引擎开发 | 5人天 |
| Milvus部署 | 3人天 |
| 向量索引配置 | 2人天 |
| 访问控制实现 | 3人天 |
| 性能优化 | 2人天 |
| 测试验证 | 3人天 |
| **总计** | **18人天** |

## 4.1.10 相关文档

- [主项目文档](../项目工作分解结构.md)

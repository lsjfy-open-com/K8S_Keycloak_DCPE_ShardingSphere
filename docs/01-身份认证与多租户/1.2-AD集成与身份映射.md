# 1.2 AD集成与身份映射

## 1.2.1 概述

本节详细描述AD（Active Directory）集成与身份映射的实现方案，包括LDAP Federation配置、用户属性映射和角色同步。

## 1.2.2 LDAP Federation配置

### Keycloak LDAP配置

```yaml
# ldap-realm-config.json
{
  "components": {
    "org.keycloak.keys.KeyProvider": [
      {
        "name": "rsa-generated",
        "providerId": "rsa-generated",
        "enabled": true,
        "config": {
          "priority": ["100"],
          "algorithm": ["RS256"]
        }
      }
    ]
  },
  "realm": {
    "id": "customer-realm",
    "realm": "customer-realm",
    "enabled": true,
    "loginTheme": "base"
  }
}
```

### LDAP Federation Provider配置

```xml
<!-- ldap-provider-config.xml -->
<ldap-provider>
    <vendor>ad</vendor>
    <usernameLDAPAttribute>sAMAccountName</usernameLDAPAttribute>
    <rdnLDAPAttribute>cn</rdnLDAPAttribute>
    <uuidLDAPAttribute>objectGUID</uuidLDAPAttribute>
    <userObjectClasses>person, organizationalPerson, user</userObjectClasses>
    <connectionUrl>ldap://ad.customer.com:389</connectionUrl>
    <usersDn>CN=Users,DC=customer,DC=com</usersDn>
    <bindDn>CN=ServiceAccount,CN=Users,DC=customer,DC=com</bindDn>
    <bindCredential>${ldap.bindCredential}</bindCredential>
    <searchScope>1_subtree</searchScope>
    <useTruststoreSpi">ldapsTrustStore</useTruststoreSpi>
    <connectionTimeout>5000</connectionTimeout>
    <readTimeout>10000</readTimeout>
</ldap-provider>
```

## 1.2.3 用户属性映射

### 属性映射配置

```json
{
  "mappers": [
    {
      "name": "email-attribute-mapper",
      "protocol": "ldap",
      "protocolMapper": "ldap-user-attribute-mapper",
      "config": {
        "user.model.ldap.attribute": "mail",
        "user.ldap.attribute": "email",
        "attribute.name": "email",
        "attribute.list": "[]"
      }
    },
    {
      "name": "department-mapper",
      "protocol": "ldap",
      "protocolMapper": "ldap-user-attribute-mapper",
      "config": {
        "user.model.ldap.attribute": "department",
        "user.ldap.attribute": "department",
        "attribute.name": "department",
        "attribute.list": "[]"
      }
    },
    {
      "name": "tenant-id-mapper",
      "protocol": "ldap",
      "protocolMapper": "ldap-user-attribute-mapper",
      "config": {
        "user.model.ldap.attribute": "tenantId",
        "user.ldap.attribute": "company",
        "attribute.name": "tenant_id",
        "attribute.list": "[]"
      }
    }
  ]
}
```

## 1.2.4 组映射与角色同步

### AD组到应用角色映射

```json
{
  "groupMappings": [
    {
      "adGroup": "CN=Admins,CN=Groups,DC=customer,DC=com",
      "keycloakRole": "admin",
      "description": "管理员组"
    },
    {
      "adGroup": "CN=Managers,CN=Groups,DC=customer,DC=com",
      "keycloakRole": "manager",
      "description": "经理组"
    },
    {
      "adGroup": "CN=Users,CN=Groups,DC=customer,DC=com",
      "keycloakRole": "user",
      "description": "普通用户组"
    },
    {
      "adGroup": "CN=ReadOnly,CN=Groups,DC=customer,DC=com",
      "keycloakRole": "readonly",
      "description": "只读用户组"
    }
  ]
}
```

### 角色同步脚本

```python
# role_sync.py
import ldap
from keycloak import KeycloakAdmin

class RoleSynchronizer:
    def __init__(self, ldap_config, keycloak_config):
        self.ldap_conn = self.connect_ldap(ldap_config)
        self.keycloak_admin = KeycloakAdmin(
            server_url=keycloak_config['url'],
            username=keycloak_config['username'],
            password=keycloak_config['password'],
            realm_name=keycloak_config['realm']
        )
    
    def sync_groups_to_roles(self):
        """同步AD组到Keycloak角色"""
        # 1. 获取AD组
        ad_groups = self.get_ad_groups()
        
        # 2. 获取Keycloak角色
        kc_roles = self.get_keycloak_roles()
        
        # 3. 同步映射
        for mapping in GROUP_MAPPINGS:
            ad_group = mapping['adGroup']
            kc_role = mapping['keycloakRole']
            
            # 获取AD组成员
            members = self.get_group_members(ad_group)
            
            # 为成员分配角色
            for member in members:
                self.assign_role_to_user(member, kc_role)
    
    def get_group_members(self, group_dn):
        """获取AD组成员"""
        search_filter = f"(memberOf:1.2.840.113556.1.4.1941:={group_dn})"
        results = self.ldap_conn.search_s(
            "DC=customer,DC=com",
            ldap.SCOPE_SUBTREE,
            search_filter,
            ['sAMAccountName', 'mail']
        )
        return [r[1]['sAMAccountName'][0].decode() for r in results if r[1].get('sAMAccountName')]
```

## 1.2.5 租户识别逻辑

### 租户识别服务

```java
// TenantIdentificationService.java
@Service
public class TenantIdentificationService {
    
    @Autowired
    private KeycloakAdminClient keycloakAdmin;
    
    public String identifyTenant(AuthenticatedUser user) {
        // 方式1：从AD属性获取租户ID
        String tenantId = user.getAttribute("tenantId");
        if (tenantId != null && !tenantId.isEmpty()) {
            return tenantId;
        }
        
        // 方式2：从邮箱域名提取
        String email = user.getEmail();
        if (email != null) {
            String domain = email.substring(email.indexOf('@') + 1);
            tenantId = extractTenantFromDomain(domain);
            if (tenantId != null) {
                return tenantId;
            }
        }
        
        // 方式3：从AD组织单位获取
        String dn = user.getDn();
        tenantId = extractTenantFromDN(dn);
        if (tenantId != null) {
            return tenantId;
        }
        
        throw new TenantIdentificationException("无法识别用户租户");
    }
    
    private String extractTenantFromDomain(String domain) {
        // 从域名提取租户标识
        // 例如：tenant-a.customer.com -> tenant-a
        String[] parts = domain.split('.');
        return parts[0];
    }
    
    private String extractTenantFromDN(String dn) {
        // 从DN中提取OU作为租户标识
        // 例如：CN=User,OU=TenantA,DC=customer,DC=com -> TenantA
        Pattern pattern = Pattern.compile("OU=([^,]+)");
        Matcher matcher = pattern.matcher(dn);
        if (matcher.find()) {
            return matcher.group(1);
        }
        return null;
    }
}
```

## 1.2.6 跨租户会话管理

### 会话配置

```yaml
# session-config.yaml
session:
  timeout:
    access_token: 3600  # 1小时
    refresh_token: 86400  # 24小时
    sso_session_idle: 1800  # 30分钟
    sso_session_max: 28800  # 8小时
  
  cookie:
    domain: ".customer.com"
    secure: true
    http_only: true
    same_site: "strict"
  
  storage:
    type: redis
    host: redis-cluster
    port: 6379
    key_prefix: "keycloak:session:"
```

## 1.2.7 交付物清单

- [ ] AD集成配置文档
- [ ] LDAP Federation配置
- [ ] 身份映射规则配置
- [ ] 角色映射矩阵
- [ ] 会话管理方案
- [ ] 同步脚本和工具

## 1.2.8 验收标准

- [ ] AD用户可登录Keycloak
- [ ] AD组同步正常
- [ ] 角色映射正确
- [ ] 租户识别机制正常工作
- [ ] 会话管理配置生效
- [ ] 同步功能正常运行

## 1.2.9 工时估算

| 任务 | 工时 |
|-----|------|
| LDAP Federation配置 | 4人天 |
| 属性映射配置 | 3人天 |
| 组映射实现 | 3人天 |
| 租户识别逻辑 | 3人天 |
| 会话管理 | 2人天 |
| 测试验证 | 3人天 |
| **总计** | **18人天** |

## 1.2.10 相关文档

- [Keycloak多租户架构设计](./1.1-Keycloak多租户架构设计.md)
- [主项目文档](../项目工作分解结构.md)
